# Mix Poker Game Platform - Master Design Document (Draft v1.0)

## 1. プロジェクト概要 (Project Overview)

本プロジェクトは、標準的なテキサスホールデムだけでなく、極めて多様なミックスゲーム（Dramaha, Badugi, Stud系など）と、詳細なハウスルール（リシャッフル手順、ゲームローテーション）を忠実に再現可能な、軽量かつ堅牢なWebベースのポーカープラットフォームを開発することを目的とする。

### コアコンセプト

- **汎用性 (Versatility):** あらゆるルールのポーカーを記述可能な汎用エンジンの構築。
- **堅牢性 (Integrity):** サーバー権限主義（Server-Authoritative）によるチート排除と、正確なルール処理。
- **軽量性 (Performance):** SPA + WebSocketによる高速なレスポンスと、通信量削減。

---

## 2. 技術アーキテクチャ (Technical Architecture)

### 2.1 技術スタック (Tech Stack)

- **Frontend:** React (TypeScript), Vite, Tailwind CSS
    - 役割: UI描画、ユーザー入力の受け付け（ロジックは持たない）。
- **Backend:** Node.js (TypeScript)
    - 役割: ゲーム進行管理、ルール判定、ステート管理、乱数生成（CSPRNG）。
- **Real-time Communication:** Socket.io
    - 役割: イベント駆動型の双方向通信。
- **In-Memory Database:** Redis
    - 役割: 高速なゲームステート（Hot Data）の保持。
- **Persistent Database:** PostgreSQL
    - 役割: ユーザー情報、ハンド履歴、ログ、決済情報の保存。

### 2.2 通信・セキュリティ設計

- **Server-Authoritative (サーバー絶対主義):**
    - クライアントには「そのプレイヤーが見てよい情報（Public Info + Private Hand）」のみを送信する。
    - デッキの並び順や他プレイヤーのハンドはサーバーメモリ内でのみ保持し、決して送信しない。
- **Lag & Concurrency Control (ラグ・連打対策):**
    - **Sequence ID (State Versioning):** サーバーは状態更新ごとにIDをインクリメント。クライアントはアクション時に現在のIDを添付。ID不整合時はアクションを却下。
- **RNG (乱数生成):**
    - Node.js `crypto` モジュールを使用し、暗号論的安全性を持つシャッフルを実装。

---

## 3. ゲームルール仕様 (Game Rules Specifications)

### 3.1 採用ゲーム一覧 (Game Variants)

システムは以下のカテゴリとバリアントに対応する構造を持つ。

**A. Flop Games**

- PLO Ocean / PLO8 Ocean
- (4/5 card) PLO
- PLO8 / Big-O
- (4/5 card) PLO Double Board (Preflop / Bomb pot 対応)
- FLO8
- FL Dramaha (2-7 / Hi / Badugi / Hidugi / 49 / 0)
- FL Dramaha Pick'em (2-7 / Hi / Badugi / Hidugi / 49 / 0) + Penalty Rule
- PL Cry Me a River (1 vanish / 2 vanish)
- **Twist:** スプリットゲームを除くFlopゲームのHUにおいて、バーン/スタブ枚数が足りる場合に有効。

**B. Draw Games**

- (FL / PL) 2-7 Triple Draw
- NL 2-7 Single Draw (No Ante / 1.5 Ante)
- FL A-5 Triple Draw
- (FL / PL) Badugi
- FL Hidugi
- FL Baduecey Triple Draw
- FL Badacey Triple Draw
- FL Archie Triple Draw (Ari)
- NL 5card Hi Single Draw (No Ante / 1.5 Ante)

**C. Stud Games**

- FL Stud Hi
- FL Stud Razz
- FL Stud Hi-Lo (8 / Regular)
- FL Stud 2-7 Razz
- FL Stud Razzdugi
- FL Super Stud (Hi / Razz / Hi-Lo8 / Hi-Lor / 2-7 Razz / Razzdugi)

### 3.2 ベッティング構造 (Betting Structure)

- **Fix Limit (FL):** 5-10-20 (各ラウンド 5bet cap / 4 raises)
- **Stud Structure:** 2-3-10-20 (BTN Ante)
- **Pot Limit (PL) / No Limit (NL):** 1-2 (Cap: 300)
- **Buy-in Cap:** 500
- **Rake:** 10% (Cap: 10, 切り下げ計算)
- **Straddle:** No AnteのNL/PLゲームにおいて有効。

### 3.3 アンテ・ブラインド処理 (Ante & Blind Logic)

- **Blind:** プレイヤー5名以上で採用。Anteゲームでは不採用。
- **Stud Ante:**
    - **BTN Ante:** BTNが全員分を支払う。
    - **New Player Handling:**
        - A. ニュープレイヤーがBTNの場合: 全員から個別徴収。
        - B. それ以外: BTNが既存プレイヤー分を払い、ニュープレイヤーは自腹で払う。

### 3.4 ゲーム進行・ローテーション規則 (Game Rotation)

- **基本条件:** ディーラー交代時のゲームは「4PLO Double Board Bomb」固定。
- **ローテーション条件:**
    - **Active Players <= 4:** ボタンが「2周」するたびにゲームチェンジ。
    - **Active Players >= 5:** ボタンが「1周」するたびにゲームチェンジ。
- **席数・休み処理:**
    - 最大8名。
    - アクティブ8名状態で「ハンド5枚のTriple Draw」選択時: **UTGを強制休み (Sit Out)** とする。

### 3.5 リシャッフル・カード配布規則 (Reshuffle & Dealing Logic)

厳密なスタック管理（Stub, Muck, Burn, Exposed）を実装する。

- **Pattern A (通常):** バーン1枚＋スタブ底1枚を除いて配れる場合。
    - バーン→スタブから配布。
- **Pattern B (スタブ不足・バーン利用):** 次のバーン＋底1枚を除き、かつ未公開バーンを使っても足りない場合不可。
    - 
        1. バーン1枚刺し、スタブ全配布。
    - 
        1. 不足分を「最後にバーンされたカード」から順に遡って配布（Exposedは除外）。
    - 
        1. 配布後、底カードを新バーンとし、Muckから新バーンを補充。
- **Pattern C (完全不足):** 上記で配りきれない場合。
    - 
        1. [Discarded + Muck (Excluding Burns)] + [Current Stub] を混ぜてリシャッフル。
    - 
        1. 配布後、バーン1枚刺してドローカード配布。

### 3.6 その他ハウスルール

- **Odd Chip (難波):** 常に **Out of Position (OOP)** 優先。Three-quarter等でも複数チップが同ポジションに行くことはない。
- **Penalty Game:** 対象プレイヤーは「ポット獲得者」に1.5bb、「他全員」に1.5bbを支払う。

---

## 4. データ構造・ステート定義 (Data Structures)

### 4.1 GameState (JSON Schema Draft)

サーバーからクライアントへ送信される状態オブジェクト。

TypeScript

`interface GameState {
  // 基本情報
  tableId: string;
  seqId: number;         // 同期ズレ防止用シーケンスID
  gameVariant: string;   // 例: "PL_OCEAN"
  bettingType: 'FL' | 'PL' | 'NL';
  street: 'PREFLOP' | 'FLOP' | 'TURN' | 'RIVER' | 'SHOWDOWN';
  
  // ポット・ボード情報
  pot: {
    main: number;
    side: SidePot[];     // サイドポット配列
  };
  board: {
    community: Card[];
    ocean?: Card;        // Ocean Card等の特殊カード
    playerBoards?: Card[][]; // Double Board等の個人ボード用
  };

  // プレイヤー情報（自分視点でサニタイズ済み）
  players: {
    seatIndex: number;
    name: string;
    stack: number;
    bet: number;         // 現在のストリートでのベット額
    status: 'ACTIVE' | 'FOLDED' | 'SIT_OUT' | 'ALL_IN';
    isButton: boolean;
    hand: Card[] | 'HIDDEN'; // 自分以外は'HIDDEN'
    indicators: {        // Draw枚数やStudのアップカードなど
        drawCount?: number;
        upCards?: Card[];
    };
  }[];

  // アクション制御
  actionOnIndex: number; // 誰のターンか
  legalActions: {        // 可能なアクションと範囲
    canCheck: boolean;
    callAmount: number;
    minRaise: number;
    maxRaise: number;    // PL/NL用。FLなら固定
  };

  // 運営情報
  dealerOrbitCount: number; // ゲームチェンジ判定用
  handsPlayedInOrbit: number;
}`

---

## 5. 開発・運営ロードマップ (Development Roadmap)

### Phase 1: Core Engine (MVP)

- Node.js + Socket.io サーバー構築。
- 基本クラス（Deck, Player, Pot）の実装。
- **Texas Hold'em** のみの実装によるベッティングロジック（PL/NL/FL）の検証。
- Sequence IDによる同期制御の実装。

### Phase 2: Mix Game Expansion

- **Game Factory Pattern** の実装（ルールのプラグイン化）。
- Flop / Draw / Stud の各基底クラス作成。
- 主要バリアント（PLO, 2-7TD, 7Stud）の実装。
- 複雑なリシャッフルロジックの実装。

### Phase 3: Advanced Rules & UI

- ゲームローテーション（Orbit計算）の実装。
- Dramaha等の特殊複合ゲームの実装。
- 8人TD時のUTG休みロジック。
- フロントエンドのアニメーション・操作性向上。

### Phase 4: Monetization & Polish

- 課金システム（Stripe等）の統合。
    - サブスクリプション（Host権限）。
    - 機能販売。
- ログ出力・ハンド解析機能。

---

## 6. クラス設計指針 (Class Design Guidelines)

プログラムは以下のクラス階層を基準とする。

- `Table`: プレイヤー着席、ゲームサイクルの管理（Rotation）。
- `GameEngine (Abstract)`: 1ハンドの進行管理。
    - `FlopEngine`: ホールデム、オマハ系。
    - `StudEngine`: スタッド系。
    - `DrawEngine`: ドロー系。
- `HandEvaluator`: 役判定（各ルールの判定ロジックを注入）。
- `PotManager`: メイン/サイドポット、Rake、難波（OOP優先）の計算。
- `DeckManager`: 配布、バーン、スタブ、マック、リシャッフルの管理。


-----------------------------以下続き
Markdown

`# Mix Poker Game Platform - Master Design Document
Version: 1.1
Last Updated: 2026-01-13
Status: Draft

## 1. プロジェクト概要 (Project Overview)
本プロジェクトは、標準的なポーカーゲームに加え、極めて多様なミックスゲーム（Dramaha, Badugi, Stud系など）およびカジノ独自のサイドゲーム（Stand Up等）を再現可能な汎用ポーカープラットフォームを開発することを目的とする。

### コアコンセプト
1. **汎用性 (Versatility):** あらゆるルールのポーカーおよびサイドゲームを記述可能な汎用エンジン。
2. **堅牢性 (Integrity):** Server-Authoritativeによるチート排除と正確なルール処理。
3. **軽量性 (Performance):** SPA + WebSocketによる高速レスポンス。

---

## 2. 技術アーキテクチャ (Technical Architecture)

### 2.1 技術スタック
- **Frontend:** React (TypeScript), Vite, Tailwind CSS
- **Backend:** Node.js (TypeScript)
- **Real-time:** Socket.io (Event-driven)
- **State DB:** Redis (In-Memory Game State)
- **Persist DB:** PostgreSQL (User Data, Logs, Ledger)

### 2.2 セキュリティ・通信設計
- **Server-Authoritative:** クライアントは「表示端末」であり、ロジックを持たない。
- **Anti-Cheat:** 他プレイヤーのハンド情報やデッキの並びはサーバーメモリ内のみに保持し、クライアントへ送信しない。
- **Lag/Spam Protection:** Sequence IDによるアクションのバージョニング管理。

---

## 3. ゲームルール仕様 (Game Rules)

### 3.1 メインゲームバリアント (Game Variants)

#### A. Flop Games
- PLO Ocean / PLO8 Ocean
- (4/5) PLO
- PLO8 / Big-O
- (4/5) PLO Double Board (Preflop / Bomb pot 対応)
- FLO8
- FL Dramaha (2-7 / Hi / Badugi / Hidugi / 49 / 0)
- FL Dramaha Pick'em (Penalty Rule適用)
- PL Cry Me a River (1 vanish / 2 vanish)
- **Twist Rule:** Splitを除くFlopゲームのHU時、カード枚数が足りれば有効。

#### B. Draw Games
- (FL/PL) 2-7 Triple Draw
- NL 2-7 Single Draw (No Ante / 1.5 Ante)
- FL A-5 Triple Draw
- (FL/PL) Badugi / FL Hidugi
- FL Baduecey / Badacey / Archie (Ari)
- NL 5card Hi Single Draw

#### C. Stud Games
- FL Stud Hi / Razz / Hi-Lo (8/Regular)
- FL Stud 2-7 Razz / Razzdugi
- FL Super Stud (Mixed variants)

### 3.2 特殊サイドゲーム / メタゲーム (Side Games / Meta-Rules)
通常のハンド勝敗とは独立してチップが動くルール。

#### 1. The 7-2 Game (Seven-Deuce Game)
- **対象:** NLH / PLO などのハイハンドゲーム。
- **条件:** 7-2 (オフスートまたはスーテッド) でハンドに勝利する。
- **発動:** 勝利後、ハンドをショウ（公開）する必要がある（全員フォールド勝ちでも公開必須）。
- **報酬:** 全プレイヤーから事前に決めた額（例: 10bb）を徴収。

#### 2. The Stand Up Game (Nit Game)
- **進行:** ハンドを跨いで継続するゲーム。
- **開始:** 全員が「Stand Up（立っている）」状態でスタート。
- **解除:** ポットを獲得（スプリット含まず、純粋勝利）したプレイヤーは「Sit Down（座る）」状態になり、このゲームから抜ける。
- **終了:** 最後に一人だけ「Stand Up」状態のプレイヤーが残った時点で終了。
- **罰則:** 最後の敗者は、既に座った（勝利した）全プレイヤーに対し、罰則額（例: 5bb）を支払う。
- **リセット:** 罰則支払い後、再び全員Stand Upで再開するか選択。

#### 3. Bounty / Rock
- **Rock:** 特定のアイテム（Rock）を持っているプレイヤーがポットを獲得した場合、Rockの権利が移動する等のオプション。

### 3.3 ベッティング・レーキ構造
- **Limits:**
  - Fix Limit: 5-10-20 (5bet cap)
  - Stud: 2-3-10-20 (BTN Ante)
  - PL/NL: 1-2 (Cap 300)
- **Rake:** 10% (Cap 10, 切り下げ)
- **Buy-in Cap:** 500

### 3.4 運営ルール (House Rules)
- **Game Rotation:**
  - Active <= 4: ボタン2周でチェンジ。
  - Active >= 5: ボタン1周でチェンジ。
  - Dealer交代時は「4PLO Double Board Bomb」固定。
- **Odd Chips:** 常にOOP（Out of Position）優先。
- **Seat Rules:** 8人TD時、UTGは強制Sit Out。

### 3.5 リシャッフルアルゴリズム (Reshuffle Logic)
- **Deck Manager:** Stub, Muck, Burn, Exposedを厳密に配列管理。
- **Pattern A:** カード十分 → 通常配布。
- **Pattern B:** スタブ不足 → バーン1枚確保後、スタブ全配布＋Exposed以外の捨て札を最後にバーンされた順に配布。
- **Pattern C:** 完全不足 → マック（バーン除く）＋スタブをリシャッフル。

---

## 4. データ構造設計 (Data Structures)

### 4.1 GameState Object (JSON Schema Draft)
サーバーからクライアントへブロードキャストされる状態。

```typescript
interface GameState {
  // 基本メタデータ
  tableId: string;
  seqId: number;          // Action Versioning
  gameConfig: {
    variant: string;      // "FL_DRAMAHA_27" etc.
    limitType: string;
    isActiveSideGame: string[]; // ["7-2", "STAND_UP"]
  };

  // 進行状況
  street: string;         // PREFLOP, FLOP, etc.
  pot: {
    main: number;
    side: SidePot[];
  };
  
  // ボード情報
  board: {
    community: string[];  // ["Ah", "Ks", "2d"]
    ocean?: string;
    discards?: string[];  // Drawゲームの交換枚数表示用
  };

  // サイドゲーム状態 (New)
  sideGameStatus: {
    sevenDeuce?: {
        winner?: string;  // 直近の勝者
    };
    standUp?: {
        remainingPlayers: string[]; // まだ勝っていないプレイヤーID一覧
        isActive: boolean;
    };
  };

  // プレイヤー状態
  players: {
    id: string;
    seat: number;
    stack: number;
    bet: number;
    isDealer: boolean;
    status: 'ACTIVE' | 'FOLDED' | 'SIT_OUT';
    
    // ハンド情報（Server-Sideでフィルタリング必須）
    hand: string[] | 'HIDDEN'; 
    
    // ゲーム固有情報
    gameSpecific: {
      drawCount?: number; // ドロー枚数
      upCards?: string[]; // Studのオープンカード
    };
  }[];

  // アクション制御
  currentTurn: number;    // Seat Index
  allowedActions: string[];
}`

---

## 5. クラス設計 (Class Design)

### 5.1 Manager Classes

- **TableManager:** ユーザー着席、ゲーム設定、ローテーション管理（Orbit Count）。
- **SideGameManager (New):**
    - Stand Up Gameの状態保持と勝敗判定時のトリガー処理。
    - 7-2 Gameのハンド判定とボーナス支払い処理。
- **PotManager:** メイン/サイドポット計算、Odd Chip (OOP優先)、Rake計算。
- **DeckManager:** カード操作、リシャッフル手順A/B/Cの実装。

### 5.2 Game Engine Hierarchy

- **BaseGame:** 共通処理（Deal, Collect Pot）。
    - **FlopEngine:** Holdem, Omaha, Ocean。
    - **StudEngine:** 7 Stud, Razz, Super Stud。
    - **DrawEngine:** 2-7 TD, Badugi。
        - *Mixin:* **DramahaLogic** (FlopとDrawのハイブリッド判定)。

---

## 6. 開発ロードマップ (Roadmap)

1. **Phase 1: Foundation**
    - WebSocket Server, State Management, Basic NLH.
2. **Phase 2: Variant Expansion**
    - PLO, Stud, Draw Engines implementation.
    - Reshuffle Logic implementation.
3. **Phase 3: Meta-Game & Polish**
    - Side Games (7-2, Stand Up) implementation.
    - Rotation Logic & UI Animations.
4. **Phase 4: Operations**
    - Logging, Replay, Monetization.

`---

### 設計書補足：サイドゲームの実装アプローチについて

**Stand Up Game** のような「ハンドを跨ぐ」ルールは、設計上の難所になりがちです。これを解決するため、`Table` クラスの直下に `SideGameContext` という永続的なステートを持たせる設計にしました。

1.  **ハンド終了時 (Hand End):**
    * 通常のポット分配処理が終わった後、`SideGameManager` が呼び出されます。
    * 「誰がポットを取ったか」をチェックし、Stand Upリストから削除します。
    * もしリストが残り1名になった場合、自動的にそのプレイヤーのスタックから罰則金を減算し、他プレイヤーへ分配する処理（Ledger Transaction）を実行します。

2.  **7-2 Game:**
    * ショーダウン時、または全員フォールド勝利時に「ハンドを見せる (Show Hand)」ボタンをUIに追加する必要があります。
    * これを選択した場合のみ、サーバーはハンドを公開し、7-2判定を行ってボーナス移動を実行します。

この設計書（v1.1）を基盤に、次のステップ（具体的なデータベース設計や初期コード生成など）へ進むことができます。`

---------------------------続き
# ミックスポーカー開発ロードマップ：個人開発編

このロードマップは、**「まずは自分のパソコンの中で動かす」**ことから始め、最終的に**「友達とネットで遊べる」**状態を目指します。

### 【準備編】 武器と防具を揃える (所要時間: 1〜2日)

開発を始める前に、必要なツールをインストールします。これらは全て無料です。

1. **Cursor (カーソル) のインストール**:
    - **重要**: Visual Studio Code (VS Code) という定番エディタの進化版です。AIが内蔵されており、「ポーカーの役判定のコードを書いて」とチャットで指示すると、コードを自動生成してくれます。個人開発の最強の武器です。
2. **Node.js (ノード・ジェイエス) のインストール**:
    - JavaScriptをパソコン上で動かすためのエンジンです。これを入れないと始まりません。
3. **Git (ギット) / GitHub (ギットハブ) の登録**:
    - ゲームの「セーブポイント」を作るツールです。失敗しても昨日の状態に戻せるようになります。

---

### 【Lv.1】 トランプを配るだけの「ババ抜き」を作る (所要時間: 1週間)

ポーカーのルールは無視して、**「サーバーと通信してカード画像を表示する」**ことだけに集中します。

- **やること**:
    - 画面に「接続」ボタンを作る。
    - ボタンを押すと、画面にトランプが5枚ランダムに表示される。
    - もう一度押すと、違うカードになる。
- **クリア条件**: ブラウザを2つ開き、片方でボタンを押したとき、もう片方の画面には影響しない（または同期する）動きが確認できること。
- **ここでの学び**: 「クライアント（画面）」と「サーバー（裏方）」がどう会話するか（Socket.ioの基礎）を理解します。

---

### 【Lv.2】 テキサスホールデム（もどき）の実装 (所要時間: 2〜3週間)

最も基本的なルールを作ります。まだ複雑なミックスゲームは考えません。

- **やること**:
    - **チップの概念**: 「コール」「フォールド」ボタンを作り、押すと数字が減るようにする。
    - **ターン進行**: Aさんがボタンを押すまで、Bさんは押せないように制御する。
    - **勝敗判定**: 最後に手札を見て、どちらが強いか判定する（AIにコードを書かせればOK）。
- **クリア条件**: 自分のPC内でブラウザを2つ開き、一人二役でチップを賭け合い、勝った方のチップが増えること。
- **工夫点**: データベースはまだ使いません。サーバーのメモリ（一時記憶）だけで動かします（再起動すると消えますが、開発中はそれで十分です）。

---

### 【Lv.3】 「着せ替え」システムの構築 (所要時間: 2週間)

ここで初めて、ミックスゲームに対応できる**「仕組み」**を作ります。これが一番の難関ですが、ここを乗り越えれば後は楽になります。

- **やること**:
    - プログラムを「ゲーム進行役」と「ルールブック」に分ける作業（リファクタリング）をします。
    - 「今はオマハの時間だよ」と設定を変えたら、配られる枚数が2枚から4枚に変わるように改造します。
- **クリア条件**: 設定ファイルを1行書き換えるだけで、ホールデムとオマハが切り替わるようになること。

---

### 【Lv.4】 こだわりの「ハウスルール」実装 (所要時間: 1ヶ月〜)

ここからが本番です。リストアップしていただいた特殊ルールを一つずつ追加していきます。

- **やること (優先度順)**:
    1. **Drawゲーム対応**: 「カードを捨てる・交換する」処理を追加（2-7 TDなど）。
    2. **Studゲーム対応**: 一部のカードを表向きにして配る処理を追加。
    3. **リシャッフル規則**: カードが足りなくなった時の「パターンC」などの処理を実装。
    4. **特殊ルール**: BTN Anteや、難波（端数チップ）の処理。
- **アドバイス**: 全部のゲームを一気に作ろうとせず、「今週は2-7 Triple Drawを作る！」と1つずつ攻略しましょう。

---

### 【Lv.5】 インターネット公開 (所要時間: 1〜2週間)

自分のパソコンから出して、友達がアクセスできるようにします。

- **やること**:
    - **クラウド契約**: 初心者はAWSよりも「Render.com」や「Railway」というサービスがおすすめです。設定が簡単で、最初は無料で使えます。
    - **データベース接続**: ユーザー登録や戦績を保存するために、ここで初めてデータベース（PostgreSQL）を繋ぎます。
- **クリア条件**: スマホの4G回線から、自分が作ったゲームのURLにアクセスして遊べること。